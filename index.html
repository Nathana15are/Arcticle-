<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parle si ça va pas</title>
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f4f4f9;}
.container{width:90%;max-width:800px;margin:20px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
h1,h2{color:#333;}
form{display:flex;flex-direction:column;}
label{margin-bottom:5px;font-weight:bold;}
input,textarea{margin-bottom:15px;padding:10px;border:1px solid #ccc;border-radius:4px;font-size:16px;}
button{padding:10px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;}
button:hover{background:#45a049;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
table,th,td{border:1px solid #ddd;}
th,td{padding:10px;text-align:left;}
th{background:#f2f2f2;}
#adminPanel{display:none;}
</style>
</head>
<body>
<div class="container">
  <h1>Parle tout est anonyme</h1>

  <!-- Formulaire -->
  <form id="messageForm">
    <label for="nom">Ton prénom :</label>
    <input type="text" id="nom" name="nom" placeholder="Optionnel">
    <label for="message">Pourquoi tu te sens pas bien ?</label>
    <textarea id="message" name="message" rows="4" required></textarea>
    <button type="submit">Envoyer</button>
  </form>

  <hr style="margin:20px 0;">

  <!-- Admin login -->
  <div id="loginDiv">
    <h2>Admin</h2>
    <form id="loginForm">
      <label for="password">Mot de passe :</label>
      <input type="password" id="password" required>
      <button type="submit">Se connecter</button>
    </form>
  </div>

  <!-- Admin panel -->
  <div id="adminPanel">
    <h2>Messages reçus</h2>
    <table id="messagesTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Message</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="exportBtn">Exporter en XLSX</button>
  </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
const SHEETDB_URL = 'https://sheetdb.io/api/v1/st6dvxdgmf2ic';
const PASSWORD = 'Marius2013.';

// Formulaire public
const messageForm = document.getElementById('messageForm');
messageForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const nom = document.getElementById('nom').value;
  const message = document.getElementById('message').value;
  const date = new Date().toLocaleString();
  const data = {data:[{Nom:nom, Message:message, Date:date}]};
  try{
    const res = await fetch(SHEETDB_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(res.ok){
      alert('Merci, ton message a été envoyé.');
      messageForm.reset();
    }else{alert('Erreur lors de l\'envoi.');}
  }catch(err){alert('Erreur réseau.');}
});

// Admin login
const loginForm = document.getElementById('loginForm');
const adminPanel = document.getElementById('adminPanel');
const loginDiv = document.getElementById('loginDiv');
const messagesTable = document.getElementById('messagesTable').getElementsByTagName('tbody')[0];
loginForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const pass = document.getElementById('password').value;
  if(pass===PASSWORD){
    loginDiv.style.display='none';
    adminPanel.style.display='block';
    loadMessages();
  }else{alert('Mot de passe incorrect.');}
});

// Charger messages depuis SheetDB
async function loadMessages(){
  try{
    const res = await fetch(SHEETDB_URL);
    const messages = await res.json();
    messagesTable.innerHTML='';
    messages.forEach((msg,idx)=>{
      const row = messagesTable.insertRow();
      row.insertCell(0).textContent=msg.Nom;
      row.insertCell(1).textContent=msg.Message;
      row.insertCell(2).textContent=msg.Date;
      const delCell=row.insertCell(3);
      const delBtn=document.createElement('button');
      delBtn.textContent='Supprimer';
      delBtn.onclick=()=>deleteMessage(msg.id);
      delCell.appendChild(delBtn);
    });
  }catch(err){alert('Erreur chargement messages.');}
}

// Supprimer un message
async function deleteMessage(id){
  if(!confirm('Supprimer ce message ?')) return;
  try{
    const res = await fetch(`${SHEETDB_URL}/${id}`, {method:'DELETE'});
    if(res.ok){alert('Message supprimé.'); loadMessages();}
    else alert('Erreur suppression.');
  }catch(err){alert('Erreur réseau.');}
}

// Export XLSX
const exportBtn = document.getElementById('exportBtn');
exportBtn.addEventListener('click', async ()=>{
  try{
    const res = await fetch(SHEETDB_URL);
    const messages = await res.json();
    const ws = XLSX.utils.json_to_sheet(messages.map(m=>({Nom:m.Nom,Message:m.Message,Date:m.Date})));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Messages');
    XLSX.writeFile(wb,'messages_parle.xlsx');
  }catch(err){alert('Erreur export.');}
});
</script>
</body>
</html>
