<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remarques SheetDB</title>
<style>
body{font-family:system-ui,sans-serif;background:#f5f6fa;margin:0;padding:12px}
.card{max-width:720px;margin:18px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
h2{text-align:center;margin:0 0 14px}
input,select,textarea,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #e2e6ef;box-sizing:border-box}
button{background:#3bbf69;color:#fff;border:none;font-weight:700;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.row{display:flex;gap:8px}
.row>button{flex:1}
.remarque{padding:12px;margin:10px 0;border-radius:8px;background:#f1f4f8;word-break:break-word}
.valid{background:#e6fffb;border-left:4px solid #00c7b7}
.hint{font-size:.9rem;color:#666}
@media(max-width:540px){.card{padding:14px}}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h2>Connexion</h2>
  <div class="row">
    <button type="button" id="btnAdmin">Connexion Admin</button>
    <button type="button" id="btnUser">Connexion Utilisateur</button>
  </div>
  <p class="hint">Admin ajoute des remarques ; utilisateur voit ses remarques.</p>
</div>

<div class="card" id="formCard" style="display:none">
  <h2 id="titleForm">Connexion</h2>
  <input id="password" type="password" placeholder="Mot de passe" />
  <div class="row">
    <button type="button" id="btnConnexion">Se connecter</button>
    <button type="button" id="btnBack">Retour</button>
  </div>
</div>

<div class="card" id="appCard" style="display:none">
  <h2>Remarques</h2>

  <div id="adminPanel" style="display:none">
    <select id="userSelect"><option value="">Choisir un utilisateur</option></select>
    <textarea id="texte" placeholder="Écris la remarque ici"></textarea>
    <div class="row">
      <button type="button" id="btnAdd">Ajouter remarque</button>
      <button type="button" id="btnRefresh">Rafraîchir</button>
    </div>
  </div>

  <div id="status" class="hint">Chargement en attente...</div>
  <div id="list"></div>

  <div style="margin-top:12px" class="row">
    <button type="button" id="btnLogout" style="background:#e24b3b">Se déconnecter</button>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const sheetURL = "https://sheetdb.io/api/v1/jiqnkf4kvninf";
const adminPassword = "Marius2013.";
const utilisateurs = [
  {Nom:"Hamza", MotDePasse:"Hamza1"},
  {Nom:"Maya", MotDePasse:"Maya2"},
  {Nom:"Noah", MotDePasse:"Noah3"},
  {Nom:"Swan", MotDePasse:"Swan4"},
  {Nom:"Matheo", MotDePasse:"Matheo5"}
];
/* ==================== */

let currentUser = null;
let currentRole = null;

/* --- helpers DOM --- */
const loginCard = document.getElementById('loginCard');
const formCard  = document.getElementById('formCard');
const appCard   = document.getElementById('appCard');
const titleForm = document.getElementById('titleForm');
const password  = document.getElementById('password');
const userSelect= document.getElementById('userSelect');
const texteArea = document.getElementById('texte');
const listEl    = document.getElementById('list');
const statusEl  = document.getElementById('status');
const btnAdd    = document.getElementById('btnAdd');
const btnRefresh= document.getElementById('btnRefresh');
const btnConnexion = document.getElementById('btnConnexion');

/* --- events --- */
document.getElementById('btnAdmin').addEventListener('click', ()=> openForm('admin'));
document.getElementById('btnUser').addEventListener('click', ()=> openForm('user'));
document.getElementById('btnBack').addEventListener('click', ()=> { formCard.style.display='none'; loginCard.style.display='block'; password.value=''; });
document.getElementById('btnLogout').addEventListener('click', logout);
document.getElementById('btnRefresh').addEventListener('click', loadRemarks);
btnAdd.addEventListener('click', addRemark);
btnConnexion.addEventListener('click', connexion);

/* --- UI helpers --- */
function openForm(role){
  currentRole = role;
  loginCard.style.display='none';
  formCard.style.display='block';
  titleForm.textContent = role === 'admin' ? 'Connexion Admin' : 'Connexion Utilisateur';
  password.focus();
}

function showAppAsAdmin(){
  formCard.style.display='none';
  appCard.style.display='block';
  document.getElementById('adminPanel').style.display='block';
  populateUserSelect();
  loadRemarks();
}
function showAppAsUser(){
  formCard.style.display='none';
  appCard.style.display='block';
  document.getElementById('adminPanel').style.display='none';
  loadRemarks();
}

function logout(){
  currentUser = null;
  currentRole = null;
  appCard.style.display='none';
  formCard.style.display='none';
  loginCard.style.display='block';
  password.value='';
  listEl.innerHTML='';
  statusEl.textContent = '';
}

/* ====== Connexion ====== */
async function connexion(){
  btnConnexion.disabled = true;
  try{
    const mdp = password.value.trim();
    if(currentRole === 'admin' && mdp === adminPassword){
      currentUser = 'Admin';
      showAppAsAdmin();
      return;
    }
    if(currentRole === 'user'){
      const user = utilisateurs.find(u => u.MotDePasse === mdp);
      if(user){
        currentUser = user.Nom;
        showAppAsUser();
        return;
      }
    }
    alert('Mot de passe incorrect.');
  } catch(err){
    console.error(err);
    alert('Erreur pendant la connexion.');
  } finally {
    btnConnexion.disabled = false;
    password.value = '';
  }
}

/* ====== Load / Render remarques ====== */
async function loadRemarks(){
  listEl.innerHTML = '';
  statusEl.textContent = 'Chargement des remarques...';
  try{
    const res = await fetch(sheetURL);
    if(!res.ok) throw new Error('fetch failed: ' + res.status);
    const json = await res.json();
    const rows = Array.isArray(json) ? json : (json.data || []);
    if(rows.length === 0){
      statusEl.textContent = 'Aucune remarque trouvée.';
      return;
    }

    const filtered = rows.filter(r => currentUser === 'Admin' || (r.User && r.User === currentUser));
    if(filtered.length === 0){
      statusEl.textContent = 'Aucune remarque pour cet utilisateur.';
    } else {
      statusEl.textContent = `Affichage ${filtered.length} remarque(s).`;
      filtered.forEach(r => {
        const d = document.createElement('div');
        d.className = 'remarque' + ((r.Validé === 'Oui') ? ' valid' : '');
        const user = escapeHtml(r.User || 'Inconnu');
        const texte= escapeHtml(r.Texte || '');
        const adminNom = escapeHtml(r.NomCible || '');
        d.innerHTML = `<strong>${user}</strong> (${adminNom}): ${texte}`;
        listEl.appendChild(d);
      });
    }
  } catch(err){
    console.error(err);
    statusEl.textContent = 'Erreur de chargement des remarques.';
    alert('Erreur en chargeant les remarques.');
  }
}

/* ====== Ajouter remarque (Admin) ====== */
async function addRemark(){
  if(currentUser !== 'Admin'){ alert('Seulement admin peut ajouter.'); return; }
  const nom = userSelect.value;
  const texte = texteArea.value.trim();
  if(!nom){ alert('Choisis un utilisateur.'); userSelect.focus(); return; }
  if(!texte){ alert('Écris une remarque.'); texteArea.focus(); return; }

  btnAdd.disabled = true;
  statusEl.textContent = 'Envoi de la remarque...';
  try {
    const payload = { data: [ { User: nom, NomCible: currentUser, Texte: texte, Validé: "Oui" } ] };
    const res = await fetch(sheetURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Erreur serveur: ' + res.status);
    statusEl.textContent = 'Remarque ajoutée.';
    texteArea.value = '';
    await loadRemarks();
  } catch(err){
    console.error(err);
    statusEl.textContent = 'Erreur à l\'ajout.';
    alert('Erreur en ajoutant la remarque.');
  } finally { btnAdd.disabled=false; }
}

/* ====== helpers ====== */
function populateUserSelect(){
  userSelect.innerHTML = '<option value="">Choisir un utilisateur</option>';
  utilisateurs.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.Nom;
    opt.textContent = u.Nom;
    userSelect.appendChild(opt);
  });
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

</body>
</html>
