<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Remarques</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f6fa; margin:0; padding:10px; }
.container { max-width:600px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
h2 { text-align:center; margin-bottom:20px; color:#2f3640; font-size:1.5em; }
input, select, button, textarea { width:100%; padding:14px; margin:8px 0; border-radius:8px; border:1px solid #dcdde1; box-sizing:border-box; font-size:1em; }
button { background:#4cd137; color:white; border:none; cursor:pointer; font-weight:bold; transition:0.3s; }
button:hover { background:#44bd32; }
.remarque { padding:12px; margin-bottom:12px; background:#f1f2f6; border-radius:8px; position:relative; word-break:break-word; }
.validé { background-color:#dff9fb; border-left:4px solid #00cec9; }
.actions { position:absolute; top:10px; right:10px; display:flex; flex-wrap:wrap; gap:5px; }
.actions button { padding:6px 10px; font-size:0.85em; border-radius:6px; }
.actions button.delete { background:#e84118; color:white; border:none; }
.actions button.delete:hover { background:#c23616; }
.actions button:hover { opacity:0.8; }
#loginContainer button { width:48%; margin-right:2%; margin-left:0; padding:14px; }
#loginContainer button:last-child { margin-right:0; }
textarea { resize:none; height:80px; }
@media(max-width:640px){
    .container{ margin:10px; padding:15px; }
    h2{ font-size:1.3em; }
    input, select, button, textarea{ font-size:1em; padding:12px; }
    .actions { position:static; margin-top:8px; }
}
</style>
</head>
<body>

<div class="container" id="loginContainer">
    <h2>Connexion</h2>
    <button type="button" id="btnAdmin">Admin</button>
    <button type="button" id="btnUser">Utilisateur</button>
</div>

<div class="container" id="formLogin" style="display:none;">
    <h2 id="loginTitle"></h2>
    <input type="password" id="password" placeholder="Mot de passe">
    <button type="button" id="btnConnexion">Se connecter</button>
</div>

<div class="container" id="appContainer" style="display:none;">
    <h2>Remarques</h2>
    <div id="adminSection" style="display:none;">
        <select id="userSelect">
            <option value="">Choisir un utilisateur</option>
        </select>
        <textarea id="texteRemarque" placeholder="Écris la remarque ici"></textarea>
        <button type="button" id="btnAjouter">Ajouter Remarque</button>
    </div>
    <div id="remarquesList"></div>
    <button type="button" style="background:#e84118;" id="btnDeconnexion">Se Déconnecter</button>
</div>

<script>
let userType = null;
let currentUser = null;
let utilisateurs = [];
let remarques = [];

const URL_UTILISATEURS = "https://sheetdb.io/api/v1/9f486m3qgm63c";
const URL_REMARQUES = "https://sheetdb.io/api/v1/jiqnkf4kvninf";

// Fonction pour choisir le type de connexion
function typeConnexion(type){
    userType = type;
    document.getElementById('loginContainer').style.display='none';
    document.getElementById('formLogin').style.display='block';
    document.getElementById('loginTitle').innerText = type==='admin' ? 'Connexion Admin' : 'Connexion Utilisateur';
}

// Charger utilisateurs et remarques
async function chargerDonnees(){
    const respUsers = await fetch(URL_UTILISATEURS);
    utilisateurs = await respUsers.json();
    const respRem = await fetch(URL_REMARQUES);
    remarques = await respRem.json();

    if(userType==='admin'){
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">Choisir un utilisateur</option>';
        utilisateurs.forEach(u=>{
            const option = document.createElement('option');
            option.value = u.Nom;
            option.textContent = u.Nom;
            select.appendChild(option);
        });
    }
}

// Fonction de connexion
async function connexion(){
    await chargerDonnees();
    const mdp = document.getElementById('password').value.trim();

    if(userType==='admin' && mdp==='Marius2013.'){
        currentUser='Moi';
        document.getElementById('formLogin').style.display='none';
        document.getElementById('appContainer').style.display='block';
        document.getElementById('adminSection').style.display='block';
        afficherRemarques();
    } else if(userType==='user'){
        const user = utilisateurs.find(u => u.MotDePasse===mdp);
        if(user){
            currentUser=user.Nom;
            document.getElementById('formLogin').style.display='none';
            document.getElementById('appContainer').style.display='block';
            document.getElementById('adminSection').style.display='none';
            afficherRemarques();
        } else {
            alert("Mot de passe incorrect !");
        }
    } else {
        alert("Mot de passe incorrect !");
    }
}

// Afficher les remarques
function afficherRemarques(){
    const list = document.getElementById('remarquesList');
    list.innerHTML='';
    remarques.forEach((item,index)=>{
        if(currentUser==='Moi' || item.User===currentUser){
            const div = document.createElement('div');
            div.className='remarque' + (item.Validé==='true'? ' validé':'');
            div.innerHTML = `<strong>${item.NomCible}</strong>: ${item.Texte}` +
                (currentUser==='Moi'?`<div class="actions">
                <button type="button" onclick="validerRemarque(${index})">${item.Validé==='true'?'Annuler':'Valider'}</button>
                <button type="button" class="delete" onclick="supprimerRemarque(${index})">Supprimer</button>
                </div>`:'');
            list.appendChild(div);
        }
    });
}

// Ajouter une remarque
async function ajouterRemarque(){
    const nomC = document.getElementById('userSelect').value;
    const texte = document.getElementById('texteRemarque').value.trim();
    if(!nomC){ alert("Choisir un utilisateur !"); return; }
    if(texte){
        await fetch(URL_REMARQUES,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({data:{User:nomC, NomCible:nomC, Texte:texte, Validé:false}})
        });
        document.getElementById('texteRemarque').value='';
        await chargerDonnees();
        afficherRemarques();
    }
}

// Valider / Annuler une remarque
async function validerRemarque(index){
    const item = remarques[index];
    item.Validé = item.Validé==='true'?false:true;
    await fetch(`${URL_REMARQUES}/${item.id}`,{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({data:{Validé:item.Validé}})
    });
    await chargerDonnees();
    afficherRemarques();
}

// Supprimer une remarque
async function supprimerRemarque(index){
    const item = remarques[index];
    if(confirm('Supprimer cette remarque ?')){
        await fetch(`${URL_REMARQUES}/${item.id}`,{method:'DELETE'});
        await chargerDonnees();
        afficherRemarques();
    }
}

// Déconnexion
function deconnexion(){
    currentUser=null;
    document.getElementById('appContainer').style.display='none';
    document.getElementById('formLogin').style.display='none';
    document.getElementById('loginContainer').style.display='block';
    document.getElementById('password').value='';
}

// Attacher les événements après que le DOM soit chargé
document.addEventListener("DOMContentLoaded", function(){
    document.getElementById("btnConnexion").addEventListener("click", connexion);
    document.getElementById("btnAdmin").addEventListener("click", function(){ typeConnexion('admin'); });
    document.getElementById("btnUser").addEventListener("click", function(){ typeConnexion('user'); });
    document.getElementById("btnAjouter").addEventListener("click", ajouterRemarque);
    document.getElementById("btnDeconnexion").addEventListener("click", deconnexion);
});
</script>

</body>
</html>
